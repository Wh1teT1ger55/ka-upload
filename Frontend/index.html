<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMG Klassenarbeiten</title>
    <link rel="stylesheet" href="main.css">
</head>
<body onload="ladeDateien()">
    <div class="logo-schrift">
        <img src="https://www.lmg-remseck.de/sites/default/files/logo/lmg-logo-42.png" id="logo">
        <h1 id="title">Klassenarbeiten des LMG</h1>
    </div>

    <img src="https://www.lmg-remseck.de/themes/lmgbootstrap/bg.jpg" id="lmg-bild">
    <section id="main-content">
    <h1>Über diese Seite</h1>
    <p>
       Diese Seite wurde von Schülern des LMGs entworfen und beinhaltet sämtliche alte Klassenarbeiten von Lehrern. 
       Manche Arbeiten werden von Lehrern mehrmals verwendet, darum können diese teilweise hilfreich für kommende Arbeiten sein, 
       wobei nicht garantiert werden kann, dass die Arbeiten auf dieser Website genau so wieder drankommen werden. 
       Sofern man Schüler des LMGs ist und eine Klassenarbeit zuhause hat, die noch nicht auf der Website zu finden ist, dann kann diese hier hochgeladen werden.
    </p>
    <h1>Klasse:</h1>
    <p>
        <label><input type="radio" name="klasse" class="klasse" value="k5">5</label>
        <label><input type="radio" name="klasse" class="klasse" value="k6">6</label>
        <label><input type="radio" name="klasse" class="klasse" value="k7">7</label>
        <label><input type="radio" name="klasse" class="klasse" value="k8">8</label>
        <label><input type="radio" name="klasse" class="klasse" value="k9">9</label>
        <label><input type="radio" name="klasse" class="klasse" value="k10">10</label>
    </p>

    <h1>Fach:</h1>
    <p>
        <label><input type="checkbox" class="fach" value="mat">Mathe</label>
        <label><input type="checkbox" class="fach" value="deu">Deutsch</label>
        <label><input type="checkbox" class="fach" value="eng">Englisch</label>
        <label><input type="checkbox" class="fach" value="lat">Latein</label>
        <label><input type="checkbox" class="fach" value="fra">Franz</label>
        <label><input type="checkbox" class="fach" value="spa">Spanisch</label>
        <label><input type="checkbox" class="fach" value="nwt">NWT</label>
        <label><input type="checkbox" class="fach" value="phy">Physik</label>
        <label><input type="checkbox" class="fach" value="che">Chemie</label>
        <label><input type="checkbox" class="fach" value="bio">Bio</label>
        <label><input type="checkbox" class="fach" value="geo">Geo</label>
        <label><input type="checkbox" class="fach" value="wbs">WBS</label>
        <label><input type="checkbox" class="fach" value="gk">GK</label>
        <label><input type="checkbox" class="fach" value="gesch">Geschichte</label>
    </p>

    <div id="uploadSection"></div>
    <h1>UPLOAD YOUR FILES HERE!</h1>
    <form id="uploadForm">
        <label for="document">Datei hochladen:</label>
        <input type="file" name="document" id="document" required>
        <button type="submit">Hochladen</button>
    </form>
    <p id="uploadStatus"></p>

    <h1>Arbeiten:</h1>
    <div id="fileListSection" class="hidden">
        <h2>Verfügbare Klassenarbeiten</h2>
        <ul id="fileList"></ul>
    </div>
    </section>
    <script>
        document.getElementById("uploadForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            const fileInput = document.getElementById("document");
            const formData = new FormData();
            formData.append("document", fileInput.files[0]);

            const token = localStorage.getItem("authToken");
            const res = await fetch("/upload", {
                method: "POST",
                body: formData,
                credentials: "include"
            });

            const result = await res.json();
            document.getElementById("uploadStatus").textContent = result.success
                ? "Upload erfolgreich!"
                : "Upload fehlgeschlagen.";
            });

            async function ladeDateien() {
                const token = localStorage.getItem("authToken");
                if (!token) {
                    // Wenn kein Token vorhanden ist, wird der Nutzer zur Login-Seite umgeleitet.
                    window.location.href = "/login";
                    return;
                }

            const res = await fetch("/files", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    // Das Token wird im Authorization-Header gesendet. Beachte, dass dein Backend 'Bearer' erwartet.
                    "Authorization": "Bearer " + token
                },
                credentials: "include"
            });
            if (res.ok) {
                const data = await res.json();
                const list = document.getElementById("fileList");
                list.innerHTML = "";
                data.files.forEach(f => {
                    const li = document.createElement("li");
                    const btn = document.createElement("button");
                    btn.textContent = "Download: " + f;
                    btn.onclick = async () => {
                        const fileRes = await fetch(`/uploads/${f}`, {
                            method: "GET",
                            headers: {
                                "Authorization": "Bearer " + token
                            }
                        });

                        if (fileRes.ok) {
                            const blob = await fileRes.blob();
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement("a");
                            a.href = url;
                            a.download = filename;
                            a.click();
                            URL.revokeObjectURL(url);
                        } 
                        else {
                            alert("Download fehlgeschlagen oder keine Berechtigung.");
                        }
                    };

                    li.appendChild(btn);
                    list.appendChild(li);
                });
            }
            else {
                //Sofern Token ungültig wird User zur Login Seite geschickt
                window.location.href = "/login";
            }
        }
    </script>
</body>
</html>
